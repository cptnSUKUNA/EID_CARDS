<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Message Lookup</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .share-link {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .share-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .copy-button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-button:hover {
            background-color: #45a049;
        }

        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            text-align: center;
            z-index: 1000;
        }

        .cookie-buttons {
            margin-top: 10px;
        }

        .cookie-btn {
            margin: 0 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .accept-btn {
            background-color: #4CAF50;
            color: white;
        }

        .decline-btn {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>عيد سعيد</h1>
        <div id="search-section" class="search-section">
            <input type="text" id="userId" placeholder="Enter User ID" class="input-field">
            <button onclick="fetchUserData()" class="search-button">Enter</button>
        </div>
        <div id="result" class="result-section">
            <!-- Results will be displayed here -->
        </div>
        <footer class="footer">
            <p>Made with <span class="heart">❤</span> by <span class="gboy">GBOY</span></p>
        </footer>
    </div>

    <!-- Cookie consent banner -->
    <div id="cookieBanner" class="cookie-banner" style="display: none;">
        <p>This site uses cookies to remember your Eid message. Without cookies, you'll need to save the URL to access
            your message again.</p>
        <div class="cookie-buttons">
            <button class="cookie-btn accept-btn" onclick="acceptCookies()">Accept Cookies</button>
        </div>
    </div>

    <script>
        // Global variables
        const viewedIds = new Set();
        let cookiesAccepted = false;
        let incognitoMode = false;

        // Check if we're in incognito mode
        async function detectIncognito() {
            try {
                // Test localStorage
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');

                // Test more persistent storage options
                try {
                    const db = indexedDB.open('test');
                    await new Promise((resolve, reject) => {
                        db.onerror = () => {
                            incognitoMode = true;
                            resolve();
                        };
                        db.onsuccess = () => {
                            incognitoMode = false;
                            resolve();
                        };
                    });
                } catch (e) {
                    incognitoMode = true;
                }

                return incognitoMode;
            } catch (e) {
                incognitoMode = true;
                return true;
            }
        }

        // Function to save the user ID with the most appropriate method
        function saveUserId(userId) {
            // Always try localStorage first
            try {
                localStorage.setItem('eidMessageId', userId);

                // Also try to set a cookie for more persistence
                if (cookiesAccepted) {
                    const expiryDate = new Date();
                    expiryDate.setMonth(expiryDate.getMonth() + 1); // Cookie expires in 1 month
                    document.cookie = `eidMessageId=${userId}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Strict`;
                }

                return true;
            } catch (e) {
                console.log('Could not save to localStorage or cookies');
                return false;
            }
        }

        // Function to get the user ID from any available storage
        function getUserId() {
            // Try localStorage first
            const localId = localStorage.getItem('eidMessageId');
            if (localId) return localId;

            // Try cookies next
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('eidMessageId=')) {
                    return cookie.substring('eidMessageId='.length);
                }
            }

            // Try URL parameter as last resort
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Check for previous searches on page load
        async function checkPreviousSearch() {
            // Detect incognito mode first
            await detectIncognito();

            // Show cookie banner if appropriate
            if (!document.cookie.includes('cookieChoice') && !incognitoMode) {
                document.getElementById('cookieBanner').style.display = 'block';
            }

            // Try to get userId from any storage method
            const userId = getUserId();

            if (userId) {
                // User has already retrieved a message
                viewedIds.add(userId);
                const searchSection = document.getElementById('search-section');
                searchSection.style.display = 'none';

                // Fetch and display the message
                fetchStoredUserData(userId);
            } else {
                // Check if there's an ID in the URL (direct access link)
                const urlParams = new URLSearchParams(window.location.search);
                const idParam = urlParams.get('id');
                if (idParam) {
                    document.getElementById('userId').value = idParam;
                    fetchUserData(true); // true means it's from URL param
                }
            }
        }

        // Fetch data for a previously stored ID
        async function fetchStoredUserData(userId) {
            const resultDiv = document.getElementById('result');

            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const data = await response.json();
                const user = data.find(user => user.id === userId);

                if (user) {
                    resultDiv.innerHTML = `
                        <div class="success-message">
                            <h2>Happy Eid ya ${user.name}</h2>
                            <p>${user.message}</p>
                        </div>
                    `;

                    // Create a direct link for sharing or bookmarking
                    if (incognitoMode) {
                        createShareLink(userId);
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-message">
                            <p>Something went wrong. Please clear your browser data and try again.</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <p>Error loading data. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Process a new search
        async function fetchUserData(fromUrlParam = false) {
            const userId = document.getElementById('userId').value.trim();
            const resultDiv = document.getElementById('result');

            // Check if empty
            if (!userId) {
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <p>Please enter a User ID</p>
                    </div>
                `;
                return;
            }

            // Check if this ID has already been viewed
            if (viewedIds.has(userId) && !fromUrlParam) {
                resultDiv.innerHTML = `
                    <div class="success-message">
                        <p>You have already viewed this message.</p>
                    </div>
                `;
                fetchStoredUserData(userId);
                return;
            }

            // Check if any other ID has been viewed in this session
            const previousId = getUserId();
            if (previousId && previousId !== userId && !fromUrlParam) {
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <p>You have already viewed a different message. Each user can only view their own message.</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const data = await response.json();
                const user = data.find(user => user.id === userId);

                if (user) {
                    // Add to memory for current session
                    viewedIds.add(userId);

                    // Try to save the ID permanently
                    const saved = saveUserId(userId);

                    // Display the message
                    resultDiv.innerHTML = `
                        <div class="success-message">
                            <h2>Happy Eid ya ${user.name}</h2>
                            <p>${user.message}</p>
                        </div>
                    `;

                    // Create a direct link for sharing or bookmarking if in incognito
                    if (incognitoMode || !saved) {
                        createShareLink(userId);
                    }

                    // Hide the search section
                    document.getElementById('search-section').style.display = 'none';

                    // Update URL without reloading page
                    const url = new URL(window.location.href);
                    url.searchParams.set('id', userId);
                    window.history.replaceState({}, '', url);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-message">
                            <p>User not found</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <p>Error loading data. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Create a share/bookmark link
        function createShareLink(userId) {
            const resultDiv = document.getElementById('result');
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('id', userId);

            const shareDiv = document.createElement('div');
            shareDiv.className = 'share-link';
            shareDiv.innerHTML = `
                <p>${incognitoMode ? 'You\'re in incognito mode.' : 'For safekeeping:'} Bookmark this page or save this link to access your message later:</p>
                <input type="text" value="${currentUrl.href}" readonly class="share-input">
                <button onclick="copyShareLink()" class="copy-button">Copy Link</button>
            `;
            resultDiv.appendChild(shareDiv);
        }

        // Copy the share link to clipboard
        function copyShareLink() {
            const shareInput = document.querySelector('.share-input');
            shareInput.select();
            document.execCommand('copy');

            const copyButton = document.querySelector('.copy-button');
            const originalText = copyButton.innerText;
            copyButton.innerText = 'Copied!';
            setTimeout(() => {
                copyButton.innerText = originalText;
            }, 2000);
        }

        // Accept cookies
        function acceptCookies() {
            cookiesAccepted = true;
            const expiryDate = new Date();
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
            document.cookie = `cookieChoice=accepted; expires=${expiryDate.toUTCString()}; path=/; SameSite=Strict`;

            // If we already have a userId in localStorage, also save it as a cookie
            const userId = localStorage.getItem('eidMessageId');
            if (userId) {
                const expiryDate = new Date();
                expiryDate.setMonth(expiryDate.getMonth() + 1);
                document.cookie = `eidMessageId=${userId}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Strict`;
            }

            document.getElementById('cookieBanner').style.display = 'none';
        }

        // Decline cookies
        function declineCookies() {
            cookiesAccepted = false;
            const expiryDate = new Date();
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
            document.cookie = `cookieChoice=declined; expires=${expiryDate.toUTCString()}; path=/; SameSite=Strict`;
            document.getElementById('cookieBanner').style.display = 'none';
        }

        // Add enter key support
        document.getElementById('userId').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                fetchUserData();
            }
        });

        // Make functions globally available
        window.copyShareLink = copyShareLink;
        window.acceptCookies = acceptCookies;
        window.declineCookies = declineCookies;

        // Run on page load
        window.addEventListener('DOMContentLoaded', checkPreviousSearch);
    </script>
</body>

</html>
